<template>
  <div style="position:relative">
    <lightning-layout>
      <lightning-layout-item size="4" padding="around-small">
        <lightning-card title="Available Pricebooks" icon-name="utility:knowledge_base">
          <div class="slds-m-around_small slds-scrollable_y" style="height: 30vh;">
            <table class="slds-table slds-table_cell-buffer slds-table_bordered">
              <thead>
                <tr class="slds-line-height_reset">
                  <th>
                    <div class="slds-truncate">Pricebook Name</div>
                  </th>
                  <th>Active</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <template for:each={pricebooks} for:item="pricebook">
                  <tr key={pricebook.Id}>
                    <td class="slds-truncate">
                      <a data-id={pricebook.Id} style="cursor: pointer;" onclick={selectPricebook}>{pricebook.Name}</a>
                    </td>
                    <td>
                      <lightning-input style="pointer-events: none;" type="checkbox"
                        checked={pricebook.IsActive}></lightning-input>
                    </td>
                    <td class="slds-cell_action-mode" role="gridcell">
                      <lightning-button-menu icon-name="utility:down">
                        <lightning-menu-item data-id={pricebook.Id} label="Set As Active" disabled={pricebook.IsActive}
                          onclick={setActivePricebook}></lightning-menu-item>
                        <lightning-menu-item data-id={pricebook.Id} disabled={pricebook.IsActive} onclick={delPricebook}
                          label="Delete"></lightning-menu-item>
                      </lightning-button-menu>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </lightning-card>

        <div style="margin-top: 1em;">
          <lightning-card title="New Pricebook" class="slds-m-top_medium" icon-name="utility:note">
            <div class="slds-m-around_small">
              <input type="text" class="slds-input slds-m-bottom_small" id="x" placeholder="Pricebook Name"
                name="pricebook-name"></input>
              <button class="slds-button slds-button_neutral slds-button_stretch" name="pricebook-name"
                onclick={createPricebook}>Create New Pricebook</button>
            </div>
          </lightning-card>
        </div>
      </lightning-layout-item>

      <lightning-layout-item size="8" padding="around-small">
        <lightning-card title="Pricebook Details" icon-name="utility:multi_picklist">

          <lightning-tabset>
            <lightning-tab label="Standard Prices" value="standard">
              <c-quill-pricebook-standard onupdatepricebook={updateStandardPrices} standard-book={standardPricebook}>
              </c-quill-pricebook-standard>
            </lightning-tab>
            <lightning-tab label={selectedPricebookName} value="custom">
              <c-quill-pricebook-custom onupdatepricebook={updateCustomPrices} custom-book={selectedPricebook}
                standard-book={standardPricebook}>
              </c-quill-pricebook-custom>
            </lightning-tab>
          </lightning-tabset>
        </lightning-card>

        <!-- <lightning-card title="Pricebook Details" icon-name="utility:multi_picklist">
          <lightning-tabset>

            <lightning-tab label="Standard Prices" value="standard">
              
              <div class="slds-m-horizontal_medium" >
                <template if:true={standardPricebook}>
                  <div class="slds-scrollable_y" style="max-height: 60vh;">
                  <table class="slds-table slds-table_cell-buffer slds-table_bordered" style="width: 100%;">
                    <thead>
                      <tr class="slds-line-height_reset">
                        <th class="" scope="col">
                          <div>Product Name</div>
                        </th>
                        <th class="" scope="col">
                          <div>Price</div>
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      <template for:each={standardPricebook.PricebookEntries.records} for:item="item">
                        <tr key={item.Id}>
                          <td>
                            <span>{item.Product2.Name}</span>
                          </td>
                          <td>
                            <input data-id={item.Id} class="slds-input" type="number" step="0.01" 
                              value={item.UnitPrice} onchange={changeStandardPrice}></input>
                          </td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                  </div>
                </template>
                <button type="button" class="slds-m-top_small slds-button slds-button_neutral slds-button_stretch" 
                    onclick={updateStandardPrices}>Update Standard Prices</button>
              </div>
            </lightning-tab>

            <lightning-tab label="Selected Pricebook" value="custom"> 
              <div class="slds-m-horizontal_medium">

                <template if:true={selectedPricebook}>
                  <div class="slds-scrollable_y" style="max-height: 60vh; position:relative;">
                  <table data-selected class="slds-table slds-table_cell-buffer slds-table_bordered" style="width: 100%;">
                    <thead style="position:sticky; top:0px; z-index: 2; width:100%;">
                      <tr class="slds-line-height_reset">
                        <th style="text-align: center" scope="col">
                          <div>Product Name</div>
                        </th>
                        <th style="text-align: center" scope="col">
                          <div>Final Price</div>
                        </th>
                        <th style="text-align: center" scope="col">
                          <span>Discount Value</span><br>
                          <input class="slds-input" type="number" step="0.01"
                              style="width: 12ch;" onkeydown={setDiscountValueForAll}>
                        </th>
                        <th style="text-align: center" scope="col">
                          <div>
                            <span>Is Percent Discount</span><br>
                            <input type="checkbox" class="slds-checkbox"
                              onchange={setDiscountTypeForAll}/>
                          </div>
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      <template for:each={selectedPricebook.PricebookEntries.records} for:item="item">
                        <tr key={item.Id}>
                          <td class="slds-truncate" style="overflow-x: hidden;">
                            <span>{item.Product2.Name}</span>
                          </td>
                          <td style="text-align: center">
                            <span>{item.FinalPrice}</span>
                          </td>
                          <td style="text-align: center">
                            <input class="slds-input" type="number" step="0.01" value={item.Discount__c} data-id={item.Id}
                              onchange={changeDiscountValue} style="width: 12ch;"></input>
                          </td>
                          <td style="text-align: center">
                            <input type="checkbox" class="slds-checkbox" data-id={item.Id} checked={item.Is_Percent_Discount__c} 
                              onchange={changeDiscountType}></input>
                          </td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                  </div>
                  <button type="button" class="slds-m-top_small slds-button slds-button_neutral slds-button_stretch" 
                    onclick={updatePricebookPrices}>Update Pricebook</button>
                </template>

                <template if:false={selectedPricebook}>
                  <div class="slds-box">
                    <p class="slds-text-title">No Pricebook Selected</p>
                  </div>
                </template>

              </div>
            </lightning-tab>
          </lightning-tabset>
        </lightning-card> -->

      </lightning-layout-item>
    </lightning-layout>
  </div>

  <template if:true={isLoading}>
    <c-quill-spinner></c-quill-spinner>
  </template>
</template>